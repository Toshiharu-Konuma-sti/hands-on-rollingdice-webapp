services:

##############################
# monitored servers
##############################

  webapp-webui:
    container_name: webapp-webui
    hostname: webapp-webui
    build:
      dockerfile: Dockerfile-webui
    ports:
      - 8181:8181
    networks:
      - internal
      - external
    working_dir: /webui
    depends_on:
      webapp-webapi:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8181/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 20s
    restart: unless-stopped

  webapp-webapi:
    container_name: webapp-webapi
    hostname: webapp-webapi
    build:
      dockerfile: Dockerfile-webapi
    image: webapp/webapi:latest
    ports:
      - 8182:8182
    networks:
      - internal
      - external
    working_dir: /webapi
    depends_on:
      webapp-mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8182/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 20s
    restart: unless-stopped

  webapp-mysql:
    hostname: webapp-mysql
    container_name: webapp-mysql
    image: mysql:8.4.8
    ports:
      - 3306:3306
    networks:
      - internal
      - external
    command: mysqld
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped
#    logging:
#      driver: loki
#      options:
#        loki-url: http://localhost:3100/loki/api/v1/push

##############################
# networks
##############################

networks:
  internal:
    name: intra-net
    driver: bridge
    internal: true
  external:
    name: hands-net
    driver: bridge
